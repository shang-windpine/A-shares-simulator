# A股模拟交易软件 - MVP 开发计划 (BDD驱动)

## 文档目录 (建议后续拆分)

*   [1. 引言](#1-引言)
    *   [1.1. 文档目的](#11-文档目的)
    *   [1.2. MVP目标](#12-mvp目标)
*   [2. MVP范围](#2-mvp范围)
    *   [2.1. 数据范围](#21-数据范围)
    *   [2.2. 核心聚焦模块 (MVP简化版)](#22-核心聚焦模块-mvp简化版)
    *   [2.3. MVP核心功能点](#23-mvp核心功能点)
    *   [2.4. MVP阶段明确排除的功能](#24-mvp阶段明确排除的功能)
*   [3. BDD 特性与场景](#3-bdd-特性与场景)
    *   [3.1. Feature: 历史日线数据可视化](#31-feature-历史日线数据可视化-优先级-1)
    *   [3.2. Feature: 虚拟账户初始化与查询](#32-feature-虚拟账户初始化与查询-优先级-2)
    *   [3.3. Feature: 沙盒秒级模拟交易 (基于合成虚拟行情)](#33-feature-沙盒秒级模拟交易-基于合成虚拟行情-优先级-3)
    *   [3.4. Feature: 持仓管理 (基于沙盒虚拟行情)](#34-feature-持仓管理-基于沙盒虚拟行情-优先级-2)
    *   [3.5. Feature: 交易历史记录 (沙盒)](#35-feature-交易历史记录-沙盒-优先级-2)
*   [4. MVP 技术考量与架构](#4-mvp-技术考量与架构)
    *   [4.1. 核心架构：客户端/服务器](#41-核心架构客户端服务器)
    *   [4.2. 数据存储 (已更新)](#42-数据存储-已更新)
    *   [4.3. 用户界面 (GUI)](#43-用户界面-gui)
    *   [4.4. 核心交易逻辑 (Rust 服务器) (部分更新)](#44-核心交易逻辑-rust-服务器-部分更新)
    *   [4.5. 通信协议 (已更新)](#45-通信协议-已更新)
    *   [4.6. 其他技术选型](#46-其他技术选型)
*   [5. 开发工作流与顺序 (BDD驱动)](#5-开发工作流与顺序-bdd驱动)
*   [6. MVP之后 (简述)](#6-mvp之后-简述)
*   [7. 环境准备与工具](#7-环境准备与工具)

---

## 1. 引言

### 1.1. 文档目的
本文档定义了A股模拟交易软件的最小可行产品 (MVP) 的开发计划。MVP的核心目标是快速交付一个沙盒模拟交易环境，该环境基于 **用户配置或程序生成的秒级虚拟行情**，允许用户进行 **秒级** 交易操作并观察结果。同时，系统将支持展示基于 **真实历史日线数据** 的行情图表作为参照。本文档遵循行为驱动开发 (BDD) 原则，通过用户故事和场景来明确需求和验收标准。

本文档是项目开发的 **唯一** 计划蓝本，整合了此前的设计构思和架构决策。

### 1.2. MVP目标
*   基于用户配置或程序生成的 **秒级虚拟行情**，实现沙盒模拟交易功能，核心包括：虚拟资金管理、持仓管理和基础交易系统（买入、卖出、撤单）。核心交易过程需满足一定的低延迟要求。
*   支持展示2019年1月1日至2024年9月23日的A股历史 **日线级** 数据（包含开盘价、最高价、最低价、收盘价、成交量）的可视化。
*   验证核心交易逻辑（秒级撮合、T+1、简易手续费）和用户交互流程。
*   为后续迭代提供坚实的基础，采用客户端/服务器架构（Tauri桌面客户端 + Rust核心服务器）。

## 2. MVP范围

### 2.1. 数据范围
*   **真实历史数据源：** A股历史 **日线** 数据 (来自用户通过Python脚本从Tushare等渠道获取并导入)。
    *   时间跨度：2019年1月1日 至 2024年9月23日。
    *   数据粒度：**日线级别** (包含开盘价、最高价、最低价、收盘价、成交量)。
    *   存储：**MySQL**。
*   **沙盒模拟行情数据源：**
    *   **类型：** MVP阶段为 **程序化生成（例如，可配置的简单随机游走、价格振荡器）或用户手动步进/配置的虚拟秒级行情**。
    *   **数据粒度：** **秒级虚拟报价/行情** (例如，买一价、卖一价、最新价、买卖盘深度等)。
    *   **实时存储 (沙盒活动期间 - 热数据)：** **Redis** (用于存储秒级虚拟行情tick，如买卖盘，以及服务于交易撮合的活跃订单簿)。
    *   **归档存储 (沙盒活动后 - 冷数据)：** **InfluxDB** (用于日终归档存储秒级虚拟行情 tick、模拟交易产生的订单和成交记录的实时流)。
    *   **存储 (沙盒每日收盘后整合)：** 每日的模拟交易总结数据（如最终持仓、当日成交汇总、账户日终状态）将被清洗并保存到 **MySQL** 中，与真实历史数据表隔离。
*   **用户账户与交易数据 (沙盒)：**
    *   虚拟账户信息、订单、成交、持仓等核心交易数据在沙盒活动期间由Rust服务器管理。
    *   实时、高频变动的数据（如活跃订单、即时成交回报）通过 Redis 快速响应，并通过自定义协议推送到客户端。
    *   交易流水通过 InfluxDB 记录，每日收盘后核心状态数据整合到 MySQL。

### 2.2. 核心聚焦模块 (MVP简化版)
系统采用客户端/服务器架构：

*   **桌面客户端 (Desktop Client - Tauri):**
    *   **表现层 (Presentation Layer):**
        *   使用Tauri (Rust后端逻辑，Web技术构建UI) 开发的桌面GUI。
        *   负责用户输入、数据显示（历史日K图、沙盒秒级行情/聚合图表、账户、持仓、订单等）。
        *   通过自定义的轻量级TCP协议 (消息体采用Protobuf编码) 与Rust服务器通信。
*   **核心服务器 (Core Server - Rust):**
    *   **应用层 (Application Layer):**
        *   处理来自客户端的请求 (解析自定义协议消息)。
        *   协调交易、账户和行情相关的操作。
        *   MVP阶段不包含复杂的 `SimulationModeManager`，默认为基于合成秒级数据的沙盒模式。
    *   **领域层 (Domain Layer):**
        *   **核心实体：** `Account` (虚拟账户), `Stock` (股票基本信息), `Order` (订单), `Trade` (成交), `Holding` (持仓)。
        *   **核心服务：**
            *   `SandboxTickGenerator` (MVP简化版：如简单的价格数据流生成器或手动步进接口，生成的秒级行情推送到Redis)。
            *   `MatchingEngine` (基于从Redis读取的秒级虚拟行情和订单簿进行撮合)。
            *   `MarketRuleEngine` (MVP核心规则：T+1，简易手续费)。
    *   **基础设施层 (Infrastructure Layer):**
        *   **数据持久化 (MySQL):** 存储真实历史日K数据、用户虚拟账户（日终状态）、订单（日终状态）、成交（日终汇总）、持仓（日终状态）。
        *   **数据持久化 (InfluxDB):** 日终归档沙盒会话期间的秒级虚拟行情tick、实时订单状态变更流、实时成交流。
        *   **实时数据存储 (Redis):** 存储沙盒会话期间的秒级虚拟行情 (如买卖盘)、活跃订单簿、部分需要快速访问的交易状态。
        *   **行情数据获取/生成:**
            *   从MySQL加载历史日K数据。
            *   `SandboxTickGenerator` 提供秒级虚拟行情，发布至 Redis。
        *   **网络通信:** 基于TCP的自定义轻量级协议服务器，处理Protobuf编码的消息体。

### 2.3. MVP核心功能点
*   **历史行情数据展示：** **日线级**K线图展示（基于MySQL中的真实历史数据）。
*   **沙盒行情模拟与展示：**
    *   基础的 **秒级虚拟行情生成** 或手动控制机制。
    *   沙盒内股票的秒级（或聚合的，如分钟级）虚拟行情图表展示。
*   **虚拟资金管理：** 初始化虚拟资金，资金随模拟交易变动。
*   **秒级模拟交易系统：** 支持限价买入、限价卖出、撤销未成交订单（基于秒级虚拟行情）。
*   **持仓管理：** 展示用户在沙盒中当前持有的股票及其成本、基于虚拟行情的盈亏。
*   **交易历史：** 查看沙盒中已成交的交易和历史订单。
*   **数据适配与统一展示：** 客户端采用适配器/桥接模式思路，整合展示历史日K数据和沙盒交易数据（例如，在同一图表上可能有历史日K背景和当日沙盒交易标记）。

### 2.4. MVP阶段明确排除的功能
*   基于真实历史分钟/秒级数据的回放交易 (因用户提供的数据为日K)。
*   2024年9月24日之后的"现实跟踪模式"和"纯虚构模拟模式"的复杂逻辑（MVP聚焦于单一的、基于合成秒级数据的沙盒）。
*   用户注册与多账户管理 (MVP可使用单一默认虚拟账户)。
*   复杂的A股规则模拟 (如集合竞价细节、复杂的市价单转换、融资融券等)。
*   高级投资组合分析及风险指标。
*   除日K线(真实历史)和沙盒秒级/聚合行情外的复杂图表和技术指标。
*   安全性保障（如通信加密、用户认证等）。

## 3. BDD 特性与场景

### 3.1. Feature: 历史日线数据可视化 (优先级: 1)
**As a** 用户 (模拟交易者)
**I want to** 查看指定股票在特定时间范围内的历史 **日线级** K线图
**So that I can** 分析历史价格走势，为模拟交易决策提供宏观依据。

*   **Scenario: 查看股票的日线级K线图**
    *   **Given** 系统已从MySQL加载了股票代码为 "SH600036" (招商银行) 从 "2023-01-01" 到 "2023-03-31" 的历史 **日线级** 数据
    *   **And** 我在客户端界面上选择了股票 "SH600036"
    *   **And** 我选择了查看日期范围从 "2023-01-03" 到 "2023-01-31"
    *   **When** 系统通过服务器获取数据并在客户端展示行情图表
    *   **Then** 我应该能看到一个包含开盘价、收盘价、最高价、最低价和成交量的 **日线级** K线图，对应 "SH600036" 在 "2023-01-03" 至 "2023-01-31" 期间的每一交易日数据。

### 3.2. Feature: 虚拟账户初始化与查询 (优先级: 2)
**As a** 用户
**I want to** 拥有一个带有初始资金的虚拟账户，并能查询其状态
**So that I can** 开始模拟交易并跟踪我的资产。

*   **Scenario: 首次启动时初始化虚拟账户**
    *   **Given** 我是首次启动模拟交易软件
    *   **When** Rust服务器初始化我的用户环境
    *   **Then** 我应该拥有一个虚拟账户
    *   **And** 我的虚拟账户初始总资金应为 1,000,000.00 元
    *   **And** 我的虚拟账户可用资金应为 1,000,000.00 元
    *   **And** 我的虚拟账户总资产应为 1,000,000.00 元
    *   **And** 我的虚拟账户当前没有任何股票持仓。
    *   **And** 此账户状态应由服务器管理，并在必要时持久化到MySQL。

*   **Scenario: 查看虚拟账户摘要**
    *   **Given** 我的虚拟账户可用资金为 800,000.00 元
    *   **And** 我持有的股票基于当前 **沙盒秒级虚拟行情** 计算的市值为 150,000.00 元
    *   **When** 我在客户端请求查看我的账户摘要信息
    *   **Then** 服务器应计算并返回，客户端应显示我的总资产为 950,000.00 元
    *   **And** 系统应显示我的可用资金为 800,000.00 元
    *   **And** 系统应显示我的持仓市值为 150,000.00 元。

### 3.3. Feature: 沙盒秒级模拟交易 (基于合成虚拟行情) (优先级: 3)
**As a** 用户
**I want to** 在 **秒级合成虚拟行情** 中进行买入和卖出股票的模拟操作
**So that I can** 体验交易流程并检验我的交易想法。
*(MVP撮合逻辑：限价买单当 **沙盒虚拟行情卖一价 <= 买单价** 时成交；限价卖单当 **沙盒虚拟行情买一价 >= 卖单价** 时成交。成交价为委托价。手续费为简化百分比。)*

*   **Scenario: 以限价单买入股票并成功 (基于秒级虚拟行情)**
    *   **Given** 我的虚拟账户有足够的可用资金 (例如 > 10,000 元)
    *   **And** 当前沙盒 **秒级虚拟行情** 正在运行 (通过Redis发布)，股票 "SZ000001" (平安银行) 的当前虚拟卖一价为 15.00 元，虚拟买一价为 14.99 元
    *   **When** 我通过客户端提交一个限价买入订单给服务器：100 股 "SZ000001"，限价 15.00 元
    *   **Then** 我的订单应被服务器接受，在Redis中记录，并通过自定义协议通知客户端，后续状态变更通过InfluxDB记录流水
    *   **And** 当后续的 **秒级虚拟行情** (从Redis获取) 中 "SZ000001" 的虚拟卖一价变为 <= 15.00 元时，我的订单应成交
    *   **And** 我的可用资金应减少 (100 * 15.00 + 模拟买入手续费)
    *   **And** 我的持仓中应增加 100 股 "SZ000001"，成本价为 15.00 元。
    *   **And** 成交记录通过InfluxDB记录，账户和持仓状态在服务器更新（日终同步到MySQL）。

*   **Scenario: 以限价单买入股票但价格未达到导致未成交 (基于秒级虚拟行情)**
    *   **Given** 我的虚拟账户有足够的可用资金
    *   **And** 当前沙盒 **秒级虚拟行情** 正在运行 (通过Redis发布)，股票 "SZ000001" 的当前虚拟卖一价为 15.10 元
    *   **When** 我通过客户端提交一个限价买入订单给服务器：100 股 "SZ000001"，限价 15.05 元
    *   **Then** 我的订单应被服务器接受并处于"待成交"状态 (在Redis中管理，并通过自定义协议通知客户端)，并通过InfluxDB记录初始状态
    *   **And** 若在后续的 **秒级虚拟行情** 中，股票 "SZ000001" 的虚拟卖一价始终高于 15.05 元，则我的订单保持"待成交"状态。

*   **Scenario: 遵守T+1规则卖出股票 (基于沙盒日期推进)**
    *   **Given** 我在沙盒模拟时间 "T日" 通过买入订单持有了 100 股 "SZ000001"
    *   **And** 当前沙盒模拟时间仍为 "T日"
    *   **When** 我尝试提交一个限价卖出订单：100 股 "SZ000001"
    *   **Then** 我的卖出订单应被服务器拒绝，客户端提示 "T+1规则限制"。
    *   **When** 沙盒模拟时间推进到 "T+1日"
    *   **And** 沙盒 **秒级虚拟行情** 正在运行，股票 "SZ000001" 的当前虚拟买一价为 15.50 元
    *   **And** 我通过客户端提交一个限价卖出订单给服务器：100 股 "SZ000001"，限价 15.50 元
    *   **Then** 我的订单应被服务器接受
    *   **And** 当后续的 **秒级虚拟行情** 中 "SZ000001" 的虚拟买一价变为 >= 15.50 元时，我的订单应成交
    *   **And** 我的可用资金应增加 (100 * 15.50 - 模拟卖出手续费)
    *   **And** 我的持仓中 "SZ000001" 的数量应减少 100 股。

*   **Scenario: 撤销未成交的限价订单**
    *   **Given** 我有一个未成交的限价买入订单：100 股 "SZ000001"，限价 15.00 元，订单状态为"待成交"
    *   **And** 该订单导致我的部分可用资金被冻结
    *   **When** 我通过客户端选择撤销该订单
    *   **Then** 服务器应处理撤单，该订单的状态应变为"已撤销" (在Redis中更新，通过自定义协议通知客户端，InfluxDB记录流水)
    *   **And** 原先冻结的资金应返还到我的可用资金中。

### 3.4. Feature: 持仓管理 (基于沙盒虚拟行情) (优先级: 2)
**As a** 用户
**I want to** 查看我当前沙盒中持有的所有股票及其基于 **沙盒虚拟行情** 的盈亏状况
**So that I can** 了解我的投资组合表现。

*   **Scenario: 查看持仓列表**
    *   **Given** 我在沙盒中买入了 100 股 "SH600036"，平均成本价为 18.00 元
    *   **And** 我在沙盒中买入了 200 股 "SZ000001"，平均成本价为 14.50 元
    *   **And** 当前沙盒 **秒级虚拟行情** 运行到某一时刻，"SH600036" 的虚拟市价为 18.50 元，"SZ000001" 的虚拟市价为 14.00 元
    *   **When** 我在客户端请求查看我的持仓
    *   **Then** 服务器应计算并返回，客户端应该能看到一个列表，包含：
        *   "SH600036"，数量 100，成本价 18.00，虚拟市价 18.50，虚拟市值 1850.00，浮动盈亏 +50.00 元
        *   "SZ000001"，数量 200，成本价 14.50，虚拟市价 14.00，虚拟市值 2800.00，浮动盈亏 -100.00 元
    *   **And** 列表应显示总持仓虚拟市值和总浮动盈亏。

### 3.5. Feature: 交易历史记录 (沙盒) (优先级: 2)
**As a** 用户
**I want to** 查看我在沙盒中过往的订单和成交记录
**So that I can** 回顾我的交易行为。

*   **Scenario: 查看订单历史**
    *   **Given** 我在沙盒中提交过一个买入订单A (已成交)，一个卖出订单B (已撤销)，一个买入订单C (待成交)
    *   **When** 我在客户端请求查看订单历史记录
    *   **Then** 服务器应从InfluxDB (近期流水归档) 或MySQL (更早历史归档) 获取数据，客户端应能看到这三个订单的列表，包含股票代码、方向、价格、数量、提交时间及各自的最终状态 (已成交, 已撤销, 待成交)。

*   **Scenario: 查看成交历史**
    *   **Given** 我的沙盒买入订单A以10.00元成交了100股，沙盒卖出订单D以12.00元成交了50股
    *   **When** 我在客户端请求查看成交历史记录
    *   **Then** 服务器应获取数据，客户端应能看到这两笔成交的列表，包含股票代码、成交方向、成交价格、成交数量、成交金额、手续费和成交时间。

## 4. MVP 技术考量与架构

### 4.1. 核心架构：客户端/服务器
*   **Rust 服务器 (Core Server):**
    *   负责所有核心业务逻辑：账户管理、**秒级虚拟行情生成/管理 (数据推送到Redis)**、订单处理 (订单簿在Redis)、**秒级撮合 (基于Redis中的行情和订单簿)**、持仓管理、规则校验 (T+1, 费用)。
    *   数据持久化接口 (MySQL, InfluxDB, Redis)。
    *   通过自定义的轻量级TCP协议暴露服务接口 (消息体采用Protobuf编码)。
    *   使用 `tokio` 异步运行时。
*   **Tauri 桌面客户端 (Desktop Client):**
    *   GUI展现 (使用Web技术如HTML, CSS, JavaScript/TypeScript + 选定的前端框架)。
    *   用户交互处理。
    *   通过自定义的轻量级TCP协议 (消息体采用Protobuf编码) 与Rust服务器通信。
    *   Tauri的Rust部分处理与核心服务器的通信和部分视图逻辑。

### 4.2. 数据存储 (已更新)
*   **真实历史数据 (日K线等):** **MySQL**。由用户通过Python脚本从Tushare等源获取并导入。此部分用于历史行情图表展示和可能的宏观分析。
*   **沙盒会话期实时数据 (内存数据库):** **Redis**。
    *   **用途:**
        *   存储由 `SandboxTickGenerator` 生成的 **秒级虚拟行情数据** (例如，最新价、买一/卖一价、对应的量，甚至简化的买卖五档队列)。这是撮合引擎的主要行情输入。
        *   管理活跃的 **订单簿** (每个交易对的限价买单和卖单队列)。
        *   缓存需要快速访问的 **用户账户即时状态** (如可用资金、冻结资金，用于快速校验)。
        *   存储会话期间需要快速读写的临时交易状态或事件。
    *   **特点:** 满足低延迟、高并发的读写需求，确保交易核心的性能。数据在会话结束后可选择性持久化或丢弃。
*   **沙盒会话期数据归档 (时序数据库):** **InfluxDB**。
    *   **用途:**
        *   在 **日终或会话结束后**，从Redis批量归档 **秒级虚拟行情tick的完整流**。
        *   存储沙盒会话期间所有 **订单状态的详细变更流** (例如，已提交、部分成交、完全成交、已撤销等)。
        *   存储所有 **实时成交记录的详细信息**。
    *   **特点:** 优化时间序列数据的存储和查询，用于事后分析、复盘交易行为、生成详细报表。
*   **沙盒每日汇总及长期状态 (关系型数据库):** **MySQL**。
    *   **用途:**
        *   存储每日沙盒交易结束后的 **用户账户最终信息** (总资产、可用资金、总市值等)。
        *   存储每日收盘后的 **持仓快照**。
        *   存储当日 **成交记录的汇总信息** (如果需要，例如按股票汇总的成交量和成交额)。
    *   **特点:** 与真实历史数据表隔离，提供结构化的、经过整合的每日交易结果，便于长期跟踪和管理。

### 4.3. 用户界面 (GUI)
*   选用 **Tauri** 构建桌面客户端。UI界面力求简洁，优先实现核心数据显示和操作。

### 4.4. 核心交易逻辑 (Rust 服务器) (部分更新)
*   **秒级虚拟行情生成 (`SandboxTickGenerator`):** MVP阶段可以是一个简单的模块：
    *   允许用户选择一只股票，手动输入一个价格序列让其按秒"播放"。
    *   或者一个简单的随机游走模型，价格在一定范围内按秒波动。
    *   **数据流向:** 生成的秒级行情数据（至少包含最新价、模拟的买一卖一价）将发布到 **Redis** 的特定通道或键上，供撮合引擎消费。
*   **撮合引擎简化 (秒级):**
    *   当Rust服务器收到客户端订单后，将其放入对应股票的 **Redis订单簿** 中 (例如使用Sorted Set或List)。
    *   撮合引擎监听 **Redis** 中 `SandboxTickGenerator` 产生的新的秒级虚拟行情tick。
    *   撮合引擎检查该tick是否能与 **Redis订单簿** 中的订单匹配：
        *   买单成交条件: `Redis中获取的虚拟行情卖一价 <= 委托买入价`
        *   卖单成交条件: `Redis中获取的虚拟行情买一价 >= 委托卖出价`
        *   成交价: 按委托价成交（MVP简化处理）。
    *   成交后，更新Redis中的订单簿、账户信息（先在内存中快速计算，然后准备异步更新MySQL和记录InfluxDB），并将成交回报通过自定义协议推送给客户端。
*   **A股规则简化:**
    *   **T+1:** 严格执行 (基于沙盒内的日期概念)。
    *   **交易费用:** 实现一个简化的、全局可配置的费率模型（例如：佣金比例 + 最低佣金，卖出时印花税比例）。
    *   **涨跌停:** MVP阶段可不严格模拟涨跌停，或仅做简单价格范围限制。主要依赖虚拟行情生成器的范围。
    *   **最小交易单位:** 买入/卖出时检查是否为100股的整数倍（MVP简化为必须100股整数倍）。

### 4.5. 通信协议 (已更新)
*   **协议选型：** 客户端 (Tauri) 与核心服务器 (Rust) 之间将采用一个 **自定义的、基于TCP的轻量级二进制协议**。
*   **设计参考：** 该协议的设计将借鉴 **FIX (Financial Information eXchange) 协议** 的一些核心理念，但进行大幅简化以适应MVP阶段的需求。参考点可能包括：
    *   **会话管理：** 简单的连接建立、心跳检测、断开通知。MVP阶段可能不包含复杂序列号同步和消息恢复。
    *   **消息结构：** 采用 `消息头 + Protobuf消息体` 的结构。
        *   **消息头：** 可能包含固定长度的字段，如 `总消息长度 (Header + Body)`、`消息类型 (uint16)`、`Protobuf消息体长度` 等，便于快速解析和分包。
        *   **消息体：** 使用 **Protobuf (via `prost` in Rust)**进行序列化和反序列化。Protobuf 提供结构化、高效、跨语言的消息定义。
*   **消息类型定义 (使用 .proto 文件)：**
    *   例如：`LoginRequest`, `LoginResponse`, `NewOrderRequest`, `OrderUpdateResponse` (包含成交、撤单等状态), `MarketDataRequest` (订阅行情), `MarketDataSnapshot` (行情推送)等。
*   **传输层：** **TCP**，以保证消息的可靠性和顺序性。UDP 备选用于未来可能的非关键高频行情广播（MVP阶段不考虑）。
*   **优势：**
    *   相比直接使用原始 Protobuf over TCP，增加了消息边界定义和类型区分，更易于网络粘包/半包处理。
    *   相比完整 FIX，实现复杂度大大降低，同时保留了核心的结构化和可扩展性。
    *   Protobuf 的使用简化了数据结构的定义和演进。

### 4.6. 其他技术选型
*   **日期与时间处理 (Rust):** `chrono` crate。
*   **数值计算 (Rust):** 标准库类型或 `rust_decimal` (用于精确金额计算)。
*   **错误处理 (Rust):** `anyhow` / `thiserror`。
*   **序列化 (Rust):** `serde` (配合 `prost` 用于Protobuf，以及可能的其他序列化需求)。
*   **日志 (Rust):** `tracing` 或 `log` + `env_logger`。
*   **内存数据库客户端 (Rust):** `redis-rs` crate for Redis.
*   **Python脚本:** 用于从Tushare获取历史日K数据并导入MySQL。

## 5. 开发工作流与顺序 (BDD驱动)

对于上述每个Scenario：
1.  **讨论与澄清 (Collaborate):** 明确场景细节。
2.  **定义场景 (Define):** 用Gherkin风格 (Given/When/Then) 编写场景描述。
3.  **编写测试 (Test):**
    *   服务器端：针对业务逻辑编写单元/集成测试 (例如，测试撮合逻辑、与Redis的交互)。
    *   客户端/服务器：可考虑基于自定义协议接口的集成测试。
4.  **实现功能 (Implement):**
    *   **优先开发Rust服务器核心功能：**
        1.  基础账户管理、订单实体、持仓实体。
        2.  简易手续费计算。
        3.  T+1规则校验。
        4.  自定义TCP协议框架 (消息头定义、Protobuf消息体集成) 与服务框架。
        5.  `SandboxTickGenerator` (将数据推送到Redis)。
        6.  基于Redis中行情和订单簿的撮合引擎。
        7.  Redis集成：用于行情、订单簿、实时状态。
        8.  InfluxDB集成：日终归档秒级虚拟行情、订单和成交流水。
        9.  MySQL集成：存储/读取历史日K，存储用户账户、日终交易汇总。
    *   **并行/后续开发Tauri桌面客户端：**
        1.  基础界面布局。
        2.  与服务器的自定义协议通信实现 (Protobuf反序列化)。
        3.  历史日K图展示。
        4.  沙盒行情展示、下单、撤单、账户信息、持仓、交易历史等界面。
        5.  数据展示的适配逻辑。
5.  **重构 (Refactor):** 优化代码结构，保持测试通过。
6.  **重复 (Repeat):** 进行下一个场景/功能。

**模块解耦重点：**
*   交易模块（服务器端）应高度内聚和抽象，不直接依赖于特定数据源的格式，而是处理标准化的内部数据结构。
*   展示模块（客户端）通过适配器模式处理来自服务器的不同类型数据（历史日K，沙盒秒级/聚合行情，交易数据），以实现统一或协调的视图。

## 6. MVP之后 (简述)
MVP完成后，可基于用户反馈和项目目标，逐步迭代以下功能：
*   完善A股规则模拟 (更真实的撮合，市价单，更细致的费用)。
*   增强沙盒虚拟行情生成器 (引入更多模型和可配置性)。
*   实现"纯虚构模拟模式"的独立行情生成和管理。
*   实现"现实跟踪模式" (若能解决真实高频数据源问题)。
*   增强分析功能和图表。
*   优化性能和用户体验。
*   安全性增强。

## 7. 环境准备与工具
*   **数据库:** MySQL Server, InfluxDB, **Redis Server**。
*   **开发语言:** Rust (最新稳定版), Python (数据脚本)。
*   **Rust工具链:** Cargo, `rust-analyzer` (IDE)。
*   **Tauri开发环境:** Node.js, npm/yarn, Web前端技术栈 (HTML, CSS, JS/TS + 框架如Vue/React/Svelte或纯JS)。
*   **Protobuf:** `protoc`编译器, `prost` & `prost-build` (Rust).
*   **版本控制:** Git。
*   **Python库 (数据脚本):** `tushare`, `mysql-connector-python` (或相应ORM), **`redis` (Python Redis client, if needed for scripts)**.

本文档为MVP阶段的开发提供了聚焦和指导。 